#!/bin/bash

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

check_gpu()
{
  echo -e "${YELLOW}------ 显卡检测 ------${NC}"

  # 检测所有显卡相关设备（VGA、3D controller、Display controller）
  gpu_info=$(lspci | grep -E "(VGA|3D|Display)")

  if [ -z "$gpu_info" ]; then
    echo -e "${RED}❌ 未检测到显卡设备${NC}"
    return
  fi

  # 检测Intel显卡
  intel_gpu=$(echo "$gpu_info" | grep -i "Intel")
  if [ -n "$intel_gpu" ]; then
    echo -e "${GREEN}✅ 检测到Intel显卡:${NC}"
    echo "$intel_gpu" | while read -r line; do
      echo -e "   ${GREEN}• $line${NC}"
    done
  fi

  # 检测AMD显卡（包括AMD和ATI）
  amd_gpu=$(echo "$gpu_info" | grep -iE "(AMD|ATI)")
  if [ -n "$amd_gpu" ]; then
    echo -e "${GREEN}✅ 检测到AMD显卡:${NC}"
    echo "$amd_gpu" | while read -r line; do
      echo -e "   ${GREEN}• $line${NC}"
    done
  fi

  # 检测NVIDIA显卡
  nvidia_gpu=$(echo "$gpu_info" | grep -i "NVIDIA")
  if [ -n "$nvidia_gpu" ]; then
    echo -e "${GREEN}✅ 检测到NVIDIA显卡:${NC}"
    echo "$nvidia_gpu" | while read -r line; do
      echo -e "   ${GREEN}• $line${NC}"
    done
  fi

  # 检测其他显卡
  other_gpu=$(echo "$gpu_info" | grep -viE "(Intel|AMD|ATI|NVIDIA)")
  if [ -n "$other_gpu" ]; then
    echo -e "${YELLOW}⚠️ 检测到其他显卡:${NC}"
    echo "$other_gpu" | while read -r line; do
      echo -e "   ${YELLOW}• $line${NC}"
    done
  fi

  echo ""
}

declare -A intel_drivers=(
  ["OpenGL支持"]="mesa"
  ["32bit OpenGL支持"]="lib32-mesa"
  ["Vulkan支持"]="vulkan-intel"
  ["32bit Vulkan支持"]="lib32-vulkan-intel"
  ["Xorg Server支持"]="xorg-server"
)

intel_order=("OpenGL支持" "32bit OpenGL支持" "Vulkan支持" "32bit Vulkan支持" "Xorg Server支持")

declare -A amd_drivers=(
  ["AMD开源驱动"]="xf86-video-amdgpu"
  ["AMD老驱动(GCN架构)"]="xf86-video-ati"
  ["OpenGL支持"]="mesa"
  ["32bit OpenGL支持"]="lib32-mesa"
  ["Vulkan支持"]="vulkan-radeon"
  ["32bit Vulkan支持"]="lib32-vulkan-radeon"
)

amd_order=("AMD开源驱动" "AMD老驱动(GCN架构)" "OpenGL支持" "32bit OpenGL支持" "Vulkan支持" "32bit Vulkan支持")

declare -A nvidia_drivers=(
  ["NVIDIA开源驱动"]="nvidia-open"
  ["NVIDIA老驱动(不建议安装)"]="xf86-video-nouveau"
)

nvidia_order=("NVIDIA开源驱动" "NVIDIA老驱动(不建议安装)")

check_intel()
{
  echo -e "\n${YELLOW}------ Intel驱动检测 ------${NC}"

  for driver in "${intel_order[@]}"; do
    if pacman -Qs "${intel_drivers[$driver]}" > /dev/null; then
      echo -e "${GREEN}✅ 已安装 $driver: ${intel_drivers[$driver]}${NC}"
    else
      echo -e "${RED}❌ 缺失 $driver: ${intel_drivers[$driver]}${NC}"
    fi
  done

  if pacman -Qs 'xf86-video-intel' > /dev/null; then
    echo -e "${YELLOW}⚠️ 检测到已安装 xf86-video-intel，该驱动较旧且有bug，建议卸载 ${NC}"
  fi
}

check_amd()
{
  echo -e "\n${YELLOW}------ AMD驱动检测 ------${NC}"

  for driver in "${amd_order[@]}"; do
    if pacman -Qs "${amd_drivers[$driver]}" > /dev/null; then
      echo -e "${GREEN}✅ 已安装 $driver: ${amd_drivers[$driver]}${NC}"
    else
      echo -e "${RED}❌ 缺失 $driver: ${amd_drivers[$driver]}${NC}"
    fi
  done
}

check_nvidia()
{
  echo -e "\n${YELLOW}------ NVIDIA驱动检测 ------${NC}"

  for driver in "${nvidia_order[@]}"; do
    if pacman -Qs "${nvidia_drivers[$driver]}" > /dev/null; then
      echo -e "${GREEN}✅ 已安装 $driver: ${nvidia_drivers[$driver]}${NC}"
    else
      echo -e "${RED}❌ 缺失 $driver: ${nvidia_drivers[$driver]}${NC}"
    fi
  done
}

check_xorg()
{
  echo -e "\n${YELLOW}------ xorg通用驱动检测 ------${NC}"
  if pacman -Qs 'xf86-video-vesa' > /dev/null; then
    echo -e "${GREEN}✅ 已安装 xf86-video-vesa ${NC}"
  else
    echo -e "未安装 xf86-video-vesa"
  fi
}

check_gpu
check_xorg
check_intel
check_amd
check_nvidia
